# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

type: "charm"
name: postfix-relay-configurator
title: Postfix Relay Configurator
subordinate: true
summary: Subordinate charm for configuring the Postfix Relay charm
links:
  issues: https://github.com/canonical/postfix-relay-operators/issues
  source: https://github.com/canonical/postfix-relay-operators
  contact: https://launchpad.net/~canonical-is-devops
  documentation: https://discourse.charmhub.io/t/postfix-relay-configurator-documentation-overview/19017

description: |
  Installs the configuration files for the Postfix Relay charm for
  specific user, hosts, or networks.

base: ubuntu@24.04
platforms:
  amd64:

parts:
  charm:
    plugin: charm
    source: .
    build-snaps:
      - rustup
    override-build: |
      rustup default stable
      craftctl default
    build-packages:
      - libffi-dev
      - libssl-dev
      - pkg-config

config:
  options:
    additional_smtpd_recipient_restrictions:
      type: string
      description: |
        YAML list of additional smtpd_recipient_restrictions.

        http://www.postfix.org/postconf.5.html#smtpd_recipient_restrictions
    append_x_envelope_to:
      type: boolean
      default: false
      description: |
        Configure Postfix to append X-Envelope-To header consisting of the
        email address of the recipient, per the envelope.

        This is useful to allow end users filter by destination when they
        receive emails for multiple individual or shared aliases.
    enable_reject_unknown_sender_domain:
      type: boolean
      default: true
      description: |
        Reject mail for when sender's domain cannot be resolved.

        http://www.postfix.org/postconf.5.html#reject_unknown_sender_domain
    enable_spf:
      type: boolean
      default: false
      description: Enable SPF checking.
    enable_smtp_auth:
      type: boolean
      default: true
      description: Enable SMTP authentication.
    relay_access_sources:
      type: string
      description: |
        YAML list of entries to restrict access based on CIDR source per:

        http://www.postfix.org/cidr_table.5.html
    relay_domains:
      type: string
      description: |
        YAML list of destination domains this system will relay mail to.

        http://www.postfix.org/postconf.5.html#relay_domains
    relay_host:
      type: string
      description: SMTP relay host (or smart host) to forward mail to.
    relay_recipient_maps:
      type: string
      description: |
        YAML map of lookups that alias specific mail addresses or
        domains to other local or remote addresses.

        Allows for all configured aliases and transports to be valid
        recipients for relay_domains.

        http://www.postfix.org/postconf.5.html#relay_recipient_maps
    restrict_recipients:
      type: string
      description: YAML map for restrictions by recipient address or domain.
    restrict_senders:
      type: string
      description: YAML map for restrictions by sender address or domain.
    restrict_sender_access:
      type: string
      description: |
        YAML list of domains, addresses, or hosts senders to restrict relay from.
    sender_login_maps:
      type: string
      description: |
        YAML map with entries to sender addresses to authenticated users.

        See https://www.postfix.org/postconf.5.html for details.
    spf_skip_addresses:
      type: string
      description: YAML list of CIDR addresses to skip SPF checks (allowlist).
    transport_maps:
      type: string
      description: |
        YAML map from recipient address to
        message delivery transport or next-hop destination.

        http://www.postfix.org/postconf.5.html#transport_maps
    virtual_alias_domains:
      type: string
      description: |
        YAML list of domains for which all addresses are aliased to
        addresses in other local or remote domains.

        http://www.postfix.org/postconf.5.html#virtual_alias_domains
    virtual_alias_maps:
      type: string
      description: |
        YAML map of lookup table entries that alias specific mail addresses or
        domains to other local or remote addresses.

        http://www.postfix.org/postconf.5.html#virtual_alias_maps
    virtual_alias_maps_type:
      type: string
      default: "hash"
      description: |
        Specify the map type used for virtual aliases.

        https://www.postfix.org/DATABASE_README.html#types
